name: Download Torrent and Create Release

on:
  issues:
    types: [opened]

jobs:
  prepare:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'download-request') || contains(github.event.issue.body, '### Magnet Links')
    permissions:
      issues: write
    outputs:
      magnet_links: ${{ steps.parse.outputs.magnet_links }}
      total_count: ${{ steps.parse.outputs.total_count }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Parse issue body
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/download-request.yml
        continue-on-error: true
        
      - name: Exit if not download request
        if: steps.issue-parser.outcome == 'failure'
        run: |
          echo "Not a download request issue, skipping..."
          exit 1
          
      - name: Parse magnet links into JSON array
        id: parse
        env:
          PARSED_JSON: ${{ steps.issue-parser.outputs.jsonString }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          
          echo "$PARSED_JSON" > parsed.json
          jq -r '.magnet_links' parsed.json > magnets.txt
          
          # Convert to JSON array for matrix
          MAGNET_ARRAY="[]"
          INDEX=0
          while IFS= read -r MAGNET_LINK; do
            if [[ "$MAGNET_LINK" =~ ^magnet: ]]; then
              INFO_HASH=$(echo "$MAGNET_LINK" | grep -oP 'btih:\K[^&]+' || echo "unknown")
              MAGNET_ARRAY=$(echo "$MAGNET_ARRAY" | jq --arg magnet "$MAGNET_LINK" --arg hash "$INFO_HASH" --arg idx "$INDEX" '. += [{"link": $magnet, "hash": $hash, "index": $idx}]')
              INDEX=$((INDEX + 1))
            fi
          done < magnets.txt
          
          echo "magnet_links=$MAGNET_ARRAY" >> $GITHUB_OUTPUT
          echo "total_count=$INDEX" >> $GITHUB_OUTPUT
          
          echo "Prepared $INDEX magnet links for parallel download"
          
      - name: Comment on issue - Starting downloads
        uses: actions/github-script@v7
        with:
          script: |
            const magnetData = JSON.parse('${{ steps.parse.outputs.magnet_links }}');
            const totalCount = '${{ steps.parse.outputs.total_count }}';
            
            let magnetList = '';
            magnetData.forEach((m, i) => {
              magnetList += `${i + 1}. Info Hash: \`${m.hash}\`\n`;
            });
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ **Starting Parallel Download Process**
            
            **Total Torrents:** ${totalCount}
            
            **Magnet Links:**
            ${magnetList}
            
            ‚ö° All torrents will download in parallel. Please wait...`
            })

  download:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        magnet: ${{ fromJson(needs.prepare.outputs.magnet_links) }}
      fail-fast: false
      max-parallel: 10
      
    steps:
      - name: Install aria2c
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2
          
      - name: Download public tracker list
        run: |
          curl -o trackers.txt https://cf.trackerslist.com/best.txt
          TRACKERS=$(cat trackers.txt | tr '\n' ',' | sed 's/,$//')
          echo "TRACKER_LIST=$TRACKERS" >> $GITHUB_ENV
          
      - name: Download torrent
        id: download
        run: |
          mkdir -p downloads
          
          echo "============================================"
          echo "Downloading Torrent #${{ matrix.magnet.index }}"
          echo "Info Hash: ${{ matrix.magnet.hash }}"
          echo "============================================"
          
          aria2c \
            --dir=./downloads \
            --seed-time=0 \
            --max-overall-upload-limit=1K \
            --bt-tracker="$TRACKER_LIST" \
            --bt-tracker-connect-timeout=5 \
            --bt-tracker-timeout=10 \
            --bt-max-peers=100 \
            --bt-request-peer-speed-limit=100K \
            --max-connection-per-server=16 \
            --split=16 \
            --min-split-size=1M \
            --enable-dht=true \
            --enable-dht6=false \
            --bt-enable-lpd=true \
            --enable-peer-exchange=true \
            --follow-torrent=mem \
            --summary-interval=10 \
            --console-log-level=notice \
            "${{ matrix.magnet.link }}"
          
          # Get downloaded filename
          FILENAME=$(find ./downloads -type f | head -n 1 | xargs basename)
          echo "Downloaded: $FILENAME"
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: torrent-${{ matrix.magnet.index }}-${{ matrix.magnet.hash }}
          path: ./downloads/*
          retention-days: 1

  create-release:
    needs: [prepare, download]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-downloads
          
      - name: Organize files
        id: organize
        run: |
          mkdir -p release-files
          
          # Move all files from artifact directories to release-files
          find all-downloads -type f -exec mv {} release-files/ \;
          
          echo "Files to release:"
          ls -lah release-files/
          
          FILE_COUNT=$(find release-files -type f | wc -l)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          # Create release name
          FIRST_FILE=$(find release-files -type f | head -n 1 | xargs basename)
          RELEASE_NAME=$(echo "$FIRST_FILE" | sed 's/\.[^.]*$//' | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g' | cut -c1-40)
          RELEASE_TAG="${RELEASE_NAME}-$(date +%s)"
          
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.organize.outputs.release_tag }}
          name: "Download Bundle - ${{ steps.organize.outputs.file_count }} file(s)"
          body: |
            **Files Downloaded:** ${{ steps.organize.outputs.file_count }}
            **Download Method:** Parallel processing
            
            ---
            Downloaded via torrent from issue #${{ github.event.issue.number }}
          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Comment on issue - Success
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **All Downloads Complete!**
            
            **Summary:**
            - Total Files: ${{ steps.organize.outputs.file_count }}
            - Download Method: Parallel processing (faster!)
            
            üì¶ **Release Created:** [${{ steps.organize.outputs.release_tag }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.organize.outputs.release_tag }})`
            })
            
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              state_reason: 'completed'
            })
          
      - name: Comment on issue - Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Release creation failed**\n\nSome torrents may have downloaded successfully. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })

  notify-failures:
    needs: [prepare, download]
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write
      
    steps:
      - name: Comment on issue - Download failures
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è **Some downloads failed**\n\nOne or more torrents failed to download. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n\nSuccessful downloads (if any) will still be included in the release.'
            })
