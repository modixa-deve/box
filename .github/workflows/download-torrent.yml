name: Download Torrent and Create Release

on:
  issues:
    types: [opened]

jobs:
  download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check if issue uses download template
        id: check_template
        run: |
          # Check if issue body contains magnet_link field from our template
          if echo "${{ github.event.issue.body }}" | grep -q "### Magnet Link"; then
            echo "is_download_request=true" >> $GITHUB_OUTPUT
          else
            echo "is_download_request=false" >> $GITHUB_OUTPUT
          fi
        
      - name: Parse issue body
        if: steps.check_template.outputs.is_download_request == 'true'
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/download-request.yml
          
      - name: Comment on issue - Starting download
        if: steps.check_template.outputs.is_download_request == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ Starting download... This may take a few minutes.'
            })
            
      - name: Install aria2c
        if: steps.check_template.outputs.is_download_request == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2
          
      - name: Download torrent
        if: steps.check_template.outputs.is_download_request == 'true'
        id: download
        run: |
          mkdir -p downloads
          MAGNET_LINK="${{ fromJson(steps.issue-parser.outputs.jsonString).magnet_link }}"
          
          echo "Starting download with aria2c..."
          aria2c \
            --dir=./downloads \
            --seed-time=0 \
            --max-overall-upload-limit=1K \
            --bt-max-peers=50 \
            --bt-request-peer-speed-limit=100K \
            --max-connection-per-server=5 \
            --split=5 \
            --enable-dht=true \
            --bt-enable-lpd=true \
            --follow-torrent=mem \
            "$MAGNET_LINK"
          
          echo "Download completed!"
          ls -lah ./downloads
          
          # Get the downloaded filename
          FILENAME=$(ls -1 ./downloads | head -n 1)
          # Sanitize for release tag
          RELEASE_NAME=$(echo "$FILENAME" | sed 's/\.[^.]*$//' | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g')
          RELEASE_NAME=$(echo "$RELEASE_NAME" | cut -c1-50)
          RELEASE_TAG="${RELEASE_NAME}-$(date +%s)"
          
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=$FILENAME" >> $GITHUB_OUTPUT
          
      - name: Create Release and Upload Files
        if: steps.check_template.outputs.is_download_request == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.download.outputs.release_tag }}
          name: ${{ steps.download.outputs.release_name }}
          body: |
            **Downloaded File:** ${{ steps.download.outputs.release_name }}
            
            ${{ fromJson(steps.issue-parser.outputs.jsonString).description }}
            
            ---
            Downloaded via torrent from issue #${{ github.event.issue.number }}
          files: ./downloads/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Comment on issue - Success
        if: steps.check_template.outputs.is_download_request == 'true' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Download complete! Release created: [${{ steps.download.outputs.release_name }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.download.outputs.release_tag }})'
            })
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              state_reason: 'completed'
            })
            
      - name: Comment on issue - Failure
        if: steps.check_template.outputs.is_download_request == 'true' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Download failed. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
