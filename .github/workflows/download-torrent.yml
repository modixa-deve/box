name: Download Torrent and Create Release

on:
  issues:
    types: [opened]

jobs:
  prepare:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'download-request') || contains(github.event.issue.body, '### Magnet Links')
    permissions:
      issues: write
    outputs:
      magnet_links: ${{ steps.parse.outputs.magnet_links }}
      total_count: ${{ steps.parse.outputs.total_count }}
      issue_number: ${{ github.event.issue.number }}
      
    steps:
      - name: Parse issue body
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/download-request.yml
        continue-on-error: true
        
      - name: Exit if not download request
        if: steps.issue-parser.outcome == 'failure'
        run: |
          echo "Not a download request issue, skipping..."
          exit 1
          
      - name: Parse magnet links into JSON array
        id: parse
        env:
          PARSED_JSON: ${{ steps.issue-parser.outputs.jsonString }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          
          echo "$PARSED_JSON" > parsed.json
          jq -r '.magnet_links' parsed.json > magnets.txt
          
          # Convert to JSON array for matrix
          MAGNET_ARRAY="[]"
          INDEX=0
          while IFS= read -r MAGNET_LINK; do
            if [[ "$MAGNET_LINK" =~ ^magnet: ]]; then
              INFO_HASH=$(echo "$MAGNET_LINK" | grep -oP 'btih:\K[^&]+' || echo "unknown")
              MAGNET_ARRAY=$(echo "$MAGNET_ARRAY" | jq --arg magnet "$MAGNET_LINK" --arg hash "$INFO_HASH" --arg idx "$INDEX" '. += [{"link": $magnet, "hash": $hash, "index": $idx}]')
              INDEX=$((INDEX + 1))
            fi
          done < magnets.txt
          
          # Use heredoc to safely output JSON
          {
            echo "magnet_links<<MAGNET_EOF"
            echo "$MAGNET_ARRAY"
            echo "MAGNET_EOF"
            echo "total_count=$INDEX"
          } >> $GITHUB_OUTPUT
          
          echo "Prepared $INDEX magnet links for parallel download"
          
      - name: Comment on issue - Starting downloads
        uses: actions/github-script@v7
        with:
          script: |
            const magnetData = JSON.parse(`${{ steps.parse.outputs.magnet_links }}`);
            const totalCount = '${{ steps.parse.outputs.total_count }}';
            
            let magnetList = '';
            magnetData.forEach((m, i) => {
              magnetList += `${i + 1}. Info Hash: \`${m.hash}\`\n`;
            });
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ **Starting Parallel Download Process**
            
            **Total Torrents:** ${totalCount}
            
            **Magnet Links:**
            ${magnetList}
            
            ‚ö° Each torrent will create its own release immediately upon completion!`
            })

  download-and-release:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    strategy:
      matrix:
        magnet: ${{ fromJson(needs.prepare.outputs.magnet_links) }}
      fail-fast: false
      max-parallel: 10
      
    steps:
      - name: Install aria2c
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2
          
      - name: Download public tracker list
        run: |
          curl -o trackers.txt https://cf.trackerslist.com/best.txt
          TRACKERS=$(cat trackers.txt | tr '\n' ',' | sed 's/,$//')
          echo "TRACKER_LIST=$TRACKERS" >> $GITHUB_ENV
          
      - name: Comment - Starting this torrent
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ needs.prepare.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚è¨ **Torrent #${{ matrix.magnet.index }} - Download Started**\n\nInfo Hash: \`${{ matrix.magnet.hash }}\`\n\nDownloading now...`
            })
          
      - name: Download torrent
        id: download
        run: |
          mkdir -p downloads
          
          # Generate timestamp at start
          TIMESTAMP=$(date +%s)
          
          echo "============================================"
          echo "Downloading Torrent #${{ matrix.magnet.index }}"
          echo "Info Hash: ${{ matrix.magnet.hash }}"
          echo "Timestamp: $TIMESTAMP"
          echo "============================================"
          
          aria2c \
            --dir=./downloads \
            --seed-time=0 \
            --max-overall-upload-limit=1K \
            --bt-tracker="$TRACKER_LIST" \
            --bt-tracker-connect-timeout=5 \
            --bt-tracker-timeout=10 \
            --bt-max-peers=100 \
            --bt-request-peer-speed-limit=100K \
            --max-connection-per-server=16 \
            --split=16 \
            --min-split-size=1M \
            --enable-dht=true \
            --enable-dht6=false \
            --bt-enable-lpd=true \
            --enable-peer-exchange=true \
            --follow-torrent=mem \
            --summary-interval=10 \
            --console-log-level=notice \
            "${{ matrix.magnet.link }}"
          
          echo "Download completed!"
          ls -lah ./downloads
          
          # Count files (including files in subdirectories)
          FILE_COUNT=$(find ./downloads -type f | wc -l)
          
          # Get first filename (properly handling spaces)
          FIRST_FILE=$(find ./downloads -type f -print0 | head -z -n 1)
          if [ -n "$FIRST_FILE" ]; then
            FILENAME=$(basename "$FIRST_FILE")
          else
            FILENAME="torrent-${{ matrix.magnet.index }}"
          fi
          
          echo "First file: $FILENAME"
          echo "Total files: $FILE_COUNT"
          
          # Create release name (properly handle spaces)
          RELEASE_NAME=$(echo "$FILENAME" | sed 's/\.[^.]*$//' | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g' | cut -c1-40)
          RELEASE_TAG="${TIMESTAMP}-${RELEASE_NAME}"
          
          # Build file list with URLs for release description
          FILE_LIST=""
          while IFS= read -r -d '' filepath; do
            filename=$(basename "$filepath")
            # URL encode the filename (replace spaces with %20, etc)
            encoded_filename=$(printf '%s' "$filename" | jq -sRr @uri)
            download_url="${{ github.server_url }}/${{ github.repository }}/releases/download/${RELEASE_TAG}/${encoded_filename}"
            FILE_LIST="${FILE_LIST}- [\`${filename}\`](${download_url})"$'\n'
          done < <(find ./downloads -type f -print0)
          
          # Remove trailing newline
          FILE_LIST="${FILE_LIST%$'\n'}"
          
          # Save outputs (escape special characters)
          {
            echo "filename<<EOF"
            echo "$FILENAME"
            echo "EOF"
            echo "release_tag=$RELEASE_TAG"
            echo "file_count=$FILE_COUNT"
            echo "timestamp=$TIMESTAMP"
            echo "file_list<<FILELIST_EOF"
            printf '%s' "$FILE_LIST"
            echo ""
            echo "FILELIST_EOF"
          } >> $GITHUB_OUTPUT
          
      - name: Create Release for this torrent
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.download.outputs.release_tag }}
          name: "${{ steps.download.outputs.timestamp }} - ${{ steps.download.outputs.filename }}"
          body: |
            **Timestamp:** ${{ steps.download.outputs.timestamp }}
            **Torrent #:** ${{ matrix.magnet.index }}
            **Info Hash:** `${{ matrix.magnet.hash }}`
            **Files:** ${{ steps.download.outputs.file_count }}
            
            ## Download Links
            ${{ steps.download.outputs.file_list }}
            
            ---
            Downloaded from issue #${{ needs.prepare.outputs.issue_number }}
          files: ./downloads/**
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Comment - Success
        if: success()
        env:
          FILE_LIST: ${{ steps.download.outputs.file_list }}
        uses: actions/github-script@v7
        with:
          script: |
            const fileList = process.env.FILE_LIST;
            
            github.rest.issues.createComment({
              issue_number: ${{ needs.prepare.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Torrent #${{ matrix.magnet.index }} - Complete!**

            **Timestamp:** ${{ steps.download.outputs.timestamp }}
            **Info Hash:** \`${{ matrix.magnet.hash }}\`
            **Filename:** \`${{ steps.download.outputs.filename }}\`
            **Files:** ${{ steps.download.outputs.file_count }}
            
            üì¶ **Release:** [${{ steps.download.outputs.release_tag }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.download.outputs.release_tag }})
            
            **Download Links:**
            ${fileList}`
            })
          
      - name: Comment - Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ needs.prepare.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Torrent #${{ matrix.magnet.index }} - Failed**

            **Info Hash:** \`${{ matrix.magnet.hash }}\`
            
            Failed to download. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`
            })

  finalize:
    needs: [prepare, download-and-release]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      issues: write
      
    steps:
      - name: Final summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const totalCount = '${{ needs.prepare.outputs.total_count }}';
            const conclusion = '${{ needs.download-and-release.result }}';
            
            let message = `üèÅ **All Torrents Processed**\n\n**Total:** ${totalCount} torrent(s)\n`;
            
            if (conclusion === 'success') {
              message += `\n‚úÖ All downloads completed successfully!\n\nCheck the releases page for your files.`;
            } else if (conclusion === 'failure') {
              message += `\n‚ö†Ô∏è Some downloads failed, but successful ones have been released.\n\nCheck individual torrent comments above for details.`;
            }
            
            github.rest.issues.createComment({
              issue_number: ${{ needs.prepare.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })
            
            github.rest.issues.update({
              issue_number: ${{ needs.prepare.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              state_reason: 'completed'
            })
