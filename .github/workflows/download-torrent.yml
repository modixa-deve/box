name: Download Torrent and Create Release

on:
  issues:
    types: [opened]

jobs:
  download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Parse issue body
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/download-request.yml
        continue-on-error: true
        
      - name: Exit if not download request
        if: steps.issue-parser.outcome == 'failure'
        run: |
          echo "Not a download request issue, skipping..."
          exit 0
          
      - name: Comment on issue - Starting download
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ Starting download... This may take a few minutes.'
            })
            
      - name: Install aria2c
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2
          
      - name: Download public tracker list
        run: |
          curl -o trackers.txt https://cf.trackerslist.com/best.txt
          TRACKERS=$(cat trackers.txt | tr '\n' ',' | sed 's/,$//')
          echo "TRACKER_LIST=$TRACKERS" >> $GITHUB_ENV
          echo "Added $(cat trackers.txt | wc -l) public trackers"
          
      - name: Extract magnet links to file
        run: |
          # Save the parsed JSON output to a file
          cat > parsed.json << 'EOFMARKER'
          ${{ steps.issue-parser.outputs.jsonString }}
          EOFMARKER
          
          # Extract magnet_links field using jq
          jq -r '.magnet_links' parsed.json > magnets.txt
          
          # Show what we got
          echo "Extracted magnet links:"
          cat magnets.txt
          
      - name: Parse and download torrents
        id: download
        run: |
          mkdir -p downloads
          
          # Count total magnets
          TOTAL_MAGNETS=$(grep -c "^magnet:" magnets.txt || echo "0")
          echo "Found $TOTAL_MAGNETS magnet link(s)"
          
          if [ "$TOTAL_MAGNETS" -eq 0 ]; then
            echo "Error: No valid magnet links found"
            exit 1
          fi
          
          # Download each magnet link
          COUNTER=1
          while IFS= read -r MAGNET_LINK; do
            # Skip empty lines
            if [ -z "$MAGNET_LINK" ]; then
              continue
            fi
            
            # Skip lines that don't start with magnet:
            if [[ ! "$MAGNET_LINK" =~ ^magnet: ]]; then
              continue
            fi
            
            echo "============================================"
            echo "Downloading torrent $COUNTER of $TOTAL_MAGNETS"
            echo "============================================"
            
            aria2c \
              --dir=./downloads \
              --seed-time=0 \
              --max-overall-upload-limit=1K \
              --bt-tracker="$TRACKER_LIST" \
              --bt-tracker-connect-timeout=5 \
              --bt-tracker-timeout=10 \
              --bt-max-peers=100 \
              --bt-request-peer-speed-limit=100K \
              --max-connection-per-server=16 \
              --split=16 \
              --min-split-size=1M \
              --enable-dht=true \
              --enable-dht6=false \
              --bt-enable-lpd=true \
              --enable-peer-exchange=true \
              --follow-torrent=mem \
              --summary-interval=10 \
              --console-log-level=notice \
              "$MAGNET_LINK" || echo "Warning: Failed to download torrent $COUNTER"
            
            COUNTER=$((COUNTER + 1))
          done < magnets.txt
          
          echo "============================================"
          echo "All downloads completed!"
          echo "============================================"
          ls -lah ./downloads
          
          # Count downloaded files
          FILE_COUNT=$(find ./downloads -type f | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "Error: No files were downloaded"
            exit 1
          fi
          
          echo "Successfully downloaded $FILE_COUNT file(s)"
          
          # Create release name from first file or timestamp
          FIRST_FILE=$(find ./downloads -type f | head -n 1 | xargs basename)
          RELEASE_NAME=$(echo "$FIRST_FILE" | sed 's/\.[^.]*$//' | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g' | cut -c1-40)
          RELEASE_TAG="${RELEASE_NAME}-$(date +%s)"
          
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
      - name: Create Release and Upload Files
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.download.outputs.release_tag }}
          name: "Download Bundle - ${{ steps.download.outputs.file_count }} file(s)"
          body: |
            **Files Downloaded:** ${{ steps.download.outputs.file_count }}
            
            ${{ fromJson(steps.issue-parser.outputs.jsonString).description }}
            
            ---
            Downloaded via torrent from issue #${{ github.event.issue.number }}
          files: ./downloads/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Comment on issue - Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Download complete! Successfully downloaded ${{ steps.download.outputs.file_count }} file(s).\n\nRelease: [${{ steps.download.outputs.release_tag }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.download.outputs.release_tag }})'
            })
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              state_reason: 'completed'
            })
            
      - name: Comment on issue - Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Download failed. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
