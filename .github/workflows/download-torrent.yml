name: Download Torrent and Create Release

on:
  issues:
    types: [opened]

jobs:
  download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Parse issue body
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/download-request.yml
        continue-on-error: true
        
      - name: Exit if not download request
        if: steps.issue-parser.outcome == 'failure'
        run: |
          echo "Not a download request issue, skipping..."
          exit 0
          
      - name: Comment on issue - Starting download
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ Starting download... This may take a few minutes.'
            })
            
      - name: Install aria2c
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2
          
      - name: Download public tracker list
        run: |
          # Download best trackers list from trackerslist
          curl -o trackers.txt https://cf.trackerslist.com/best.txt
          # Convert to comma-separated list for aria2c
          TRACKERS=$(cat trackers.txt | tr '\n' ',' | sed 's/,$//')
          echo "TRACKER_LIST=$TRACKERS" >> $GITHUB_ENV
          echo "Added $(cat trackers.txt | wc -l) public trackers"
          
      - name: Download torrent
        id: download
        run: |
          mkdir -p downloads
          MAGNET_LINK="${{ fromJson(steps.issue-parser.outputs.jsonString).magnet_link }}"
          
          echo "Starting download with aria2c..."
          aria2c \
            --dir=./downloads \
            --seed-time=0 \
            --max-overall-upload-limit=1K \
            --bt-tracker="$TRACKER_LIST" \
            --bt-max-peers=100 \
            --bt-request-peer-speed-limit=100K \
            --max-connection-per-server=16 \
            --max-concurrent-downloads=1 \
            --split=16 \
            --min-split-size=1M \
            --enable-dht=true \
            --bt-enable-lpd=true \
            --follow-torrent=mem \
            --summary-interval=10 \
            "$MAGNET_LINK"
          
          echo "Download completed!"
          ls -lah ./downloads
          
          # Get the downloaded filename
          FILENAME=$(find ./downloads -type f | head -n 1 | xargs basename)
          # Sanitize for release tag
          RELEASE_NAME=$(echo "$FILENAME" | sed 's/\.[^.]*$//' | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g')
          RELEASE_NAME=$(echo "$RELEASE_NAME" | cut -c1-50)
          RELEASE_TAG="${RELEASE_NAME}-$(date +%s)"
          
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=$FILENAME" >> $GITHUB_OUTPUT
          
      - name: Create Release and Upload Files
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.download.outputs.release_tag }}
          name: ${{ steps.download.outputs.release_name }}
          body: |
            **Downloaded File:** ${{ steps.download.outputs.release_name }}
            
            ${{ fromJson(steps.issue-parser.outputs.jsonString).description }}
            
            ---
            Downloaded via torrent from issue #${{ github.event.issue.number }}
          files: ./downloads/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Comment on issue - Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Download complete! Release created: [${{ steps.download.outputs.release_name }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.download.outputs.release_tag }})'
            })
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              state_reason: 'completed'
            })
            
      - name: Comment on issue - Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Download failed. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
